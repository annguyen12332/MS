<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{student/layout :: layout(~{::title}, ~{::content}, ~{::head}, ~{::scripts})}">
<head>
    <title>Tìm lớp học - Học viên</title>
    <th:block th:fragment="head">
        <style>
            .class-card {
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .class-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
            }
            .badge-seats {
                font-size: 0.85rem;
            }
        </style>
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-1">Tìm lớp học</h4>
                <p class="text-muted mb-0">Chọn lớp học phù hợp và đăng ký ngay</p>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="get" th:action="@{/student/enrollments/browse}">
                    <div class="row g-3 align-items-end">
                        <div class="col-12 col-md-8">
                            <label for="courseId" class="form-label fw-semibold">
                                <i class="fas fa-filter me-1"></i>Lọc theo khóa học
                            </label>
                            <select class="form-select" id="courseId" name="courseId" onchange="this.form.submit()">
                                <option value="">Tất cả khóa học</option>
                                <option th:each="course : ${courses}"
                                        th:value="${course.id}"
                                        th:text="${course.name + ' (' + course.code + ')'}"
                                        th:selected="${selectedCourseId != null && selectedCourseId == course.id}">
                                </option>
                            </select>
                            <!-- Debug info -->
                            <small class="text-muted d-block mt-1" th:if="${courses != null}">
                                Có <strong th:text="${#lists.size(courses)}">0</strong> khóa học
                            </small>
                        </div>
                        <div class="col-12 col-md-4">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="window.location.href='/student/enrollments/browse'">
                                <i class="fas fa-redo me-1"></i>Đặt lại
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Classes Grid -->
        <div class="row g-4">
            <div class="col-12 col-md-6 col-lg-4" th:each="class : ${classes}">
                <div class="card class-card h-100 shadow-sm border-0">
                    <div class="card-body">
                        <!-- Course Badge & Status -->
                        <div class="mb-3 d-flex justify-content-between align-items-center">
                            <span class="badge bg-primary bg-opacity-10 text-primary">
                                <i class="fas fa-book me-1"></i>
                                <span th:text="${class.course.code}">COURSE-001</span>
                            </span>
                            <!-- Class Status Badge -->
                            <span th:if="${class.status.name() == 'PENDING'}"
                                  class="badge bg-warning bg-opacity-10 text-warning">
                                <i class="fas fa-clock me-1"></i>Sắp khai giảng
                            </span>
                            <span th:if="${class.status.name() == 'ONGOING'}"
                                  class="badge bg-success bg-opacity-10 text-success">
                                <i class="fas fa-play-circle me-1"></i>Đang học
                            </span>
                        </div>

                        <!-- Class Name -->
                        <h5 class="fw-bold mb-2" th:text="${class.className}">Tên lớp học</h5>
                        <p class="text-muted small mb-3" th:text="${class.course.name}">Tên khóa học</p>

                        <!-- Class Details -->
                        <div class="mb-3">
                            <!-- Teacher -->
                            <div class="d-flex align-items-center mb-2 small">
                                <i class="fas fa-chalkboard-teacher text-muted me-2" style="width: 20px"></i>
                                <span th:if="${class.teacher}" th:text="${class.teacher.fullName}">Giảng viên</span>
                                <span th:unless="${class.teacher}" class="text-muted fst-italic">Chưa phân công</span>
                            </div>

                            <!-- Duration -->
                            <div class="d-flex align-items-center mb-2 small">
                                <i class="fas fa-clock text-muted me-2" style="width: 20px"></i>
                                <span>
                                    <span th:text="${class.startDate != null ? #temporals.format(class.startDate, 'dd/MM/yyyy') : 'Chưa xác định'}"></span>
                                    <span th:if="${class.endDate != null}"> - <span th:text="${#temporals.format(class.endDate, 'dd/MM/yyyy')}"></span></span>
                                </span>
                            </div>

                            <!-- Location -->
                            <div class="d-flex align-items-center mb-2 small" th:if="${class.room}">
                                <i class="fas fa-map-marker-alt text-muted me-2" style="width: 20px"></i>
                                <span th:text="${class.room}">Địa điểm</span>
                            </div>

                            <!-- Students -->
                            <div class="d-flex align-items-center small">
                                <i class="fas fa-users text-muted me-2" style="width: 20px"></i>
                                <span>
                                    <span class="fw-bold" th:text="${class.currentStudents}">0</span>/<span th:text="${class.maxStudents}">30</span> học viên
                                </span>
                            </div>

                            <!-- Progress Bar -->
                            <div class="progress mt-2" style="height: 6px">
                                <div class="progress-bar"
                                     th:classappend="${(class.currentStudents * 100.0 / class.maxStudents) >= 90 ? 'bg-danger' : (class.currentStudents * 100.0 / class.maxStudents) >= 70 ? 'bg-warning' : 'bg-success'}"
                                     role="progressbar"
                                     th:style="'width: ' + ${(class.currentStudents * 100.0 / class.maxStudents)} + '%'"
                                     th:attr="aria-valuenow=${class.currentStudents}, aria-valuemin=0, aria-valuemax=${class.maxStudents}">
                                </div>
                            </div>
                        </div>

                        <!-- Status & Action -->
                        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                            <!-- Seats Available Badge -->
                            <span th:if="${class.currentStudents < class.maxStudents}"
                                  class="badge badge-seats bg-success bg-opacity-10 text-success">
                                <i class="fas fa-check-circle me-1"></i>Còn chỗ
                            </span>
                            <span th:unless="${class.currentStudents < class.maxStudents}"
                                  class="badge badge-seats bg-danger bg-opacity-10 text-danger">
                                <i class="fas fa-times-circle me-1"></i>Đã đủ
                            </span>

                            <!-- Register Button -->
                            <button type="button"
                                    class="btn btn-sm btn-primary"
                                    th:disabled="${class.currentStudents >= class.maxStudents}"
                                    data-bs-toggle="modal"
                                    th:data-bs-target="'#registerModal' + ${class.id}"
                                    th:attr="data-class-id=${class.id}, data-class-name=${class.className}">
                                <i class="fas fa-user-plus me-1"></i>Đăng ký
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Registration Modal -->
                <div class="modal fade" th:id="'registerModal' + ${class.id}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header border-0">
                                <h5 class="modal-title fw-bold">Xác nhận đăng ký</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form method="post" th:action="@{/student/enrollments/register}">
                                <div class="modal-body">
                                    <input type="hidden" name="classId" th:value="${class.id}">

                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Bạn đang đăng ký lớp: <strong th:text="${class.className}"></strong>
                                    </div>

                                    <div class="mb-3">
                                        <p class="mb-2"><strong>Thông tin lớp học:</strong></p>
                                        <ul class="list-unstyled ms-3">
                                            <li class="mb-1">
                                                <i class="fas fa-book text-muted me-2"></i>
                                                <span th:text="${class.course.name}">Khóa học</span>
                                            </li>
                                            <li class="mb-1" th:if="${class.teacher}">
                                                <i class="fas fa-chalkboard-teacher text-muted me-2"></i>
                                                <span th:text="${class.teacher.fullName}">Giảng viên</span>
                                            </li>
                                            <li class="mb-1">
                                                <i class="fas fa-users text-muted me-2"></i>
                                                <span th:text="${class.currentStudents + '/' + class.maxStudents + ' học viên'}"></span>
                                            </li>
                                        </ul>
                                    </div>

                                    <div class="mb-3">
                                        <label for="notes" class="form-label">Ghi chú (không bắt buộc)</label>
                                        <textarea class="form-control" id="notes" name="notes" rows="3"
                                                  placeholder="Nhập ghi chú của bạn..."></textarea>
                                    </div>

                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <small>Đăng ký của bạn sẽ được gửi đến admin để xét duyệt.</small>
                                    </div>
                                </div>
                                <div class="modal-footer border-0">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-check me-1"></i>Xác nhận đăng ký
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="col-12" th:if="${classes == null || #lists.isEmpty(classes)}">
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-search fa-4x text-muted opacity-50 mb-3"></i>
                        <h5 class="text-muted mb-2">Không tìm thấy lớp học nào</h5>
                        <p class="text-muted mb-3" th:if="${selectedCourseId != null}">
                            Không có lớp học nào đang mở đăng ký cho khóa học này.<br>
                            Vui lòng thử chọn khóa học khác hoặc xem tất cả.
                        </p>
                        <p class="text-muted mb-3" th:unless="${selectedCourseId != null}">
                            Hiện tại chưa có lớp học nào đang mở đăng ký.<br>
                            Vui lòng quay lại sau hoặc liên hệ admin.
                        </p>
                        <div class="d-flex gap-2 justify-content-center">
                            <a th:href="@{/student/enrollments/browse}" class="btn btn-primary">
                                <i class="fas fa-list me-1"></i>Xem tất cả
                            </a>
                            <a th:href="@{/student/dashboard}" class="btn btn-outline-secondary">
                                <i class="fas fa-home me-1"></i>Về trang chủ
                            </a>
                        </div>

                        <!-- Debug info -->
                        <div class="mt-4 pt-3 border-top">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Thông tin:</strong>
                                Tìm thấy <span class="badge bg-secondary" th:text="${classes != null ? #lists.size(classes) : 0}">0</span> lớp học
                                <span th:if="${selectedCourseId != null}"> (đã lọc theo khóa học)</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:fragment="scripts">
        <!-- No additional scripts needed -->
    </th:block>
</body>
</html>
